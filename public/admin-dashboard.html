<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø¯Ù…Ù†</title>

  <style>
    /* Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø¯Ø§Ø±Ùƒ Ù…ÙˆØ¯ */
    :root {
      --primary: #0d6efd;
      --primary-dark: #0b5ed7;
      --secondary: #6c757d;
      --success: #198754;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #0dcaf0;

      --dark-bg: #121212;
      --dark-card: #1e1e1e;
      --dark-border: #2d2d2d;
      --dark-text: #f8f9fa;
      --dark-text-secondary: #adb5bd;

      --medical-blue: #1a73e8;
      --medical-red: #c62828;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Cairo", "Segoe UI", "Noto Sans Arabic", sans-serif;
      direction: rtl;
      background-color: var(--dark-bg);
      color: var(--dark-text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    /* ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØµÙØ­Ø© */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 25px;
      background: linear-gradient(135deg, var(--medical-blue) 0%, #0d47a1 100%);
      border-radius: 12px;
      color: white;
      box-shadow: 0 4px 20px rgba(13, 110, 253, 0.2);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--medical-blue);
      font-weight: bold;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
      margin-top: 5px;
    }

    h2 {
      margin-bottom: 20px;
      color: var(--dark-text);
      padding-bottom: 12px;
      border-bottom: 3px solid var(--medical-blue);
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h2 i {
      color: var(--medical-blue);
    }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    button {
      background: linear-gradient(135deg, var(--medical-blue) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, #0a58ca 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    #logoutBtn {
      background: linear-gradient(135deg, var(--medical-red) 0%, #b71c1c 100%);
    }

    #logoutBtn:hover {
      background: linear-gradient(135deg, #c62828 0%, #a01212 100%);
      box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
    }

    /* Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    .content-section {
      background: var(--dark-card);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid var(--dark-border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--dark-card);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--dark-border);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .stat-card .number {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--medical-blue);
      margin-bottom: 5px;
    }

    .stat-card .label {
      color: var(--dark-text-secondary);
      font-size: 0.9rem;
    }

    /* Ø¬Ø¯Ø§ÙˆÙ„ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--dark-border);
      border-radius: 10px;
      overflow: hidden;
    }

    th,
    td {
      border-bottom: 1px solid var(--dark-border);
      padding: 12px 12px;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background: linear-gradient(135deg, var(--medical-blue) 0%, var(--primary-dark) 100%);
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.04);
    }

    .btn-icon {
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 700;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #b02a37 100%);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #b02a37 0%, #8a1f29 100%);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    /* Ù‚Ø³Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--dark-text);
      font-weight: 500;
      font-size: 0.95rem;
    }

    .email-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 10px;
    }

    .email-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid var(--dark-border);
      cursor: pointer;
      transition: all 0.2s;
    }

    .email-option:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--medical-blue);
    }

    .email-option.selected {
      background: rgba(26, 115, 232, 0.15);
      border-color: var(--medical-blue);
    }

    .email-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .email-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .email-input {
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid var(--dark-border);
      border-radius: 8px;
      color: var(--dark-text);
      font-size: 1em;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .email-input:focus {
      outline: none;
      border-color: var(--medical-blue);
      background: rgba(255, 255, 255, 0.1);
    }

    .email-input::placeholder {
      color: var(--dark-text-secondary);
    }

    textarea {
      width: 100%;
      padding: 14px;
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid var(--dark-border);
      border-radius: 8px;
      color: var(--dark-text);
      font-size: 1em;
      font-family: inherit;
      transition: border-color 0.2s;
      min-height: 150px;
      resize: vertical;
      line-height: 1.5;
    }

    textarea:focus {
      outline: none;
      border-color: var(--medical-blue);
      background: rgba(255, 255, 255, 0.1);
    }

    textarea::placeholder {
      color: var(--dark-text-secondary);
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .send-btn {
      background: linear-gradient(135deg, var(--success) 0%, #146c43 100%);
      color: white;
    }

    .send-btn:hover {
      background: linear-gradient(135deg, #157347 0%, #0f5132 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
    }

    .clear-btn {
      background: linear-gradient(135deg, var(--warning) 0%, #ff9800 100%);
      color: #212529;
    }

    .clear-btn:hover {
      background: linear-gradient(135deg, #ffca2c 0%, #ffb300 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    }

    /* Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª */
    .response {
      margin-top: 15px;
      padding: 14px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      display: none;
    }

    .response.show {
      display: block;
    }

    .success {
      background: rgba(25, 135, 84, 0.15);
      color: var(--success);
      border-right: 4px solid var(--success);
    }

    .error {
      background: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      border-right: 4px solid var(--danger);
    }

    .info {
      background: rgba(13, 202, 240, 0.15);
      color: var(--info);
      border-right: 4px solid var(--info);
    }

    /* ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© */
    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: var(--dark-text-secondary);
      font-size: 0.9rem;
      border-top: 1px solid var(--dark-border);
    }

    /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ */
    @media (max-width: 992px) {
      .header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }

      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .header {
        padding: 20px;
      }

      h1 {
        font-size: 1.5rem;
      }

      h2 {
        font-size: 1.2rem;
      }

      .email-options {
        grid-template-columns: 1fr;
      }

      .content-section {
        padding: 20px;
      }

      button,
      .action-btn {
        padding: 10px 20px;
        font-size: 0.9rem;
      }

      .stats-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 15px;
      }

      h1 {
        font-size: 1.3rem;
      }

      h2 {
        font-size: 1.1rem;
      }

      .content-section {
        padding: 15px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>

  <!-- Ø®Ø· Cairo Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
  <!-- ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØµÙØ­Ø© -->
  <div class="header">
    <div class="header-content">
      <div class="logo">Ù…</div>
      <div>
        <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ù…Ù†</h1>
        <div class="subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</div>
      </div>
    </div>
    <button id="logoutBtn">
      <i class="fas fa-sign-out-alt"></i>
      ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    </button>
  </div>

  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="number" id="totalUsers">-</div>
      <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
    </div>
    <div class="stat-card">
      <div class="number" id="totalRecipients">-</div>
      <div class="label">Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† (Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)</div>
    </div>
    <div class="stat-card">
      <div class="number" id="totalSent">-</div>
      <div class="label">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</div>
    </div>
    <div class="stat-card">
      <div class="number" id="lastSent">-</div>
      <div class="label">Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„</div>
    </div>
  </div>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div class="content-section">
    <h2><i class="fas fa-users"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h2>
    <table id="usersTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
          <th>Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="5">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Ù‚Ø³Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
  <div class="content-section">
    <h2><i class="fas fa-envelope"></i> Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</h2>

    <div class="form-group">
      <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:</label>
      <div class="email-options" id="emailOptions">
        <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
      </div>
    </div>

    <div class="form-group">
      <label>Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ø§Ù‹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹:</label>
      <div class="email-input-group">
        <input type="email" id="customEmail" class="email-input" placeholder="example@domain.com">
        <button type="button" id="addCustomEmail" class="action-btn" style="background: var(--info); color:#001018;">
          <i class="fas fa-plus"></i>
          Ø¥Ø¶Ø§ÙØ©
        </button>
      </div>
    </div>

    <div class="form-group">
      <label for="messageInput">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
      <textarea id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." required></textarea>
    </div>

    <div class="action-buttons">
      <button id="sendMessageBtn" class="action-btn send-btn">
        <i class="fas fa-paper-plane"></i>
        Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      </button>

      <button id="clearFormBtn" class="action-btn clear-btn">
        <i class="fas fa-eraser"></i>
        Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      </button>
    </div>

    <div id="sendResponse" class="response"></div>
  </div>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© -->
  <div class="content-section">
    <h2><i class="fas fa-paper-plane"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h2>
    <table id="sentMessagesTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
          <th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ØªØ°ÙŠÙŠÙ„ -->
  <div class="footer">
    <p>Â© 2024 Ù†Ø¸Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
  </div>

  <script>
    // Ø¹Ù†Ø§ØµØ± DOM
    const usersTableBody = document.querySelector("#usersTable tbody");
    const sentMessagesTableBody = document.querySelector("#sentMessagesTable tbody");

    const logoutBtn = document.getElementById('logoutBtn');
    const emailOptionsContainer = document.getElementById('emailOptions');
    const customEmailInput = document.getElementById('customEmail');
    const addCustomEmailBtn = document.getElementById('addCustomEmail');

    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const clearFormBtn = document.getElementById('clearFormBtn');
    const sendResponse = document.getElementById('sendResponse');

    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    const totalUsersEl = document.getElementById('totalUsers');
    const totalRecipientsEl = document.getElementById('totalRecipients');
    const totalSentEl = document.getElementById('totalSent');
    const lastSentEl = document.getElementById('lastSent');

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©
    let usersCache = [];          // Ù…Ù† /api/admin/users
    let messagesCache = [];       // Ù…Ù† /api/admin/messages

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† (Ù…Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† + Ø§ÙŠÙ…ÙŠÙ„Ø§Øª Ù…Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ§Ù‹)
    let emailList = [];           // {email,label,checked,source}
    let totalMessagesSent = 0;
    let lastMessageSent = null;

    // Ù…Ø³Ø§Ø¹Ø¯ Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„
    function showResponse(message, type) {
      sendResponse.textContent = message;
      sendResponse.className = `response ${type} show`;
      setTimeout(() => sendResponse.classList.remove('show'), 5000);
    }

    // ====== Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ======
    async function loadUsers() {
      try {
        const res = await fetch('/api/admin/users');
        if (!res.ok) throw new Error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†');

        const users = await res.json();
        usersCache = Array.isArray(users) ? users : [];

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        usersTableBody.innerHTML = '';
        if (usersCache.length === 0) {
          usersTableBody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>';
        } else {
          usersCache.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHtml(user.name ?? '')}</td>
              <td>${escapeHtml(user.email ?? '')}</td>
              <td>${escapeHtml(user.phone ?? '')}</td>
              <td>${user.receivedAt ? new Date(user.receivedAt).toLocaleString('ar-EG') : '-'}</td>
              <td>
                <button class="btn-icon btn-danger" data-action="delete-user" data-email="${encodeURIComponent(user.email ?? '')}">
                  ğŸ—‘ï¸
                </button>
              </td>
            `;
            usersTableBody.appendChild(tr);
          });
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        usersTableBody.querySelectorAll('button[data-action="delete-user"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const emailToDelete = decodeURIComponent(btn.getAttribute('data-email'));
            if (!emailToDelete) return;

            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${emailToDelete} ØŸ`)) return;

            try {
              const delRes = await fetch(`/api/admin/user/${encodeURIComponent(emailToDelete)}`, {
                method: 'DELETE'
              });
              const data = await delRes.json().catch(() => ({}));
              if (delRes.ok) {
                alert(data.message || 'ØªÙ… Ø§Ù„Ø­Ø°Ù');
                await loadUsers();
                await loadMessages();
              } else {
                alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
              }
            } catch {
              alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            }
          });
        });

        // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        buildEmailOptionsFromUsers();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        totalUsersEl.textContent = usersCache.length;
        totalRecipientsEl.textContent = emailList.length;

      } catch (error) {
        usersTableBody.innerHTML = '<tr><td colspan="5">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>';
        usersCache = [];
        buildEmailOptionsFromUsers(); // Ù„ØªÙØ§Ø¯ÙŠ ØµÙØ­Ø© ÙØ§Ø¶ÙŠØ©
        totalUsersEl.textContent = '0';
        totalRecipientsEl.textContent = emailList.length;
      }
    }

    function buildEmailOptionsFromUsers() {
      // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
      const manualEmails = emailList.filter(e => e.source === 'manual');

      // Ø§Ø¨Ù†ÙŠ Ù…Ù† usersCache
      const userEmails = usersCache
        .filter(u => u && u.email)
        .map(u => ({
          email: String(u.email),
          label: u.name ? String(u.name) : String(u.email),
          checked: false,
          source: 'user'
        }));

      // Ø¯Ù…Ø¬ Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
      const map = new Map();
      [...userEmails, ...manualEmails].forEach(item => {
        const key = item.email.toLowerCase();
        if (!map.has(key)) map.set(key, item);
      });

      emailList = Array.from(map.values());
      initEmailOptionsUI();
    }

    function initEmailOptionsUI() {
      emailOptionsContainer.innerHTML = '';

      if (emailList.length === 0) {
        emailOptionsContainer.innerHTML = `<div style="color: var(--dark-text-secondary);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ„Ù…ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
        return;
      }

      emailList.forEach((emailObj, index) => {
        const emailOption = document.createElement('div');
        emailOption.className = `email-option ${emailObj.checked ? 'selected' : ''}`;

        emailOption.innerHTML = `
          <input type="checkbox" id="email-${index}" ${emailObj.checked ? 'checked' : ''} data-index="${index}">
          <div>
            <div style="font-weight: 600; color: var(--dark-text);">${escapeHtml(emailObj.label)}</div>
            <div style="color: var(--dark-text-secondary); font-size: 0.9rem;">${escapeHtml(emailObj.email)}</div>
          </div>
        `;

        const checkbox = emailOption.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function () {
          const idx = parseInt(this.getAttribute('data-index'), 10);
          emailList[idx].checked = this.checked;
          emailOption.classList.toggle('selected', this.checked);
        });

        emailOptionsContainer.appendChild(emailOption);
      });

      totalRecipientsEl.textContent = emailList.length;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¨Ø±ÙŠØ¯ ÙŠØ¯ÙˆÙŠ
    addCustomEmailBtn.addEventListener('click', () => {
      const email = customEmailInput.value.trim();
      if (!email) return showResponse('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'error');

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) return showResponse('ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');

      const exists = emailList.some(e => e.email.toLowerCase() === email.toLowerCase());
      if (exists) return showResponse('Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„', 'error');

      emailList.push({
        email,
        label: 'Ø¨Ø±ÙŠØ¯ Ù…Ø®ØµØµ',
        checked: true,
        source: 'manual'
      });

      customEmailInput.value = '';
      initEmailOptionsUI();
      showResponse(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${email}`, 'success');
    });

    customEmailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addCustomEmailBtn.click();
    });

    // ====== Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ======
    async function loadMessages() {
      try {
        const res = await fetch('/api/admin/messages');
        if (!res.ok) throw new Error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');

        const messages = await res.json();
        messagesCache = Array.isArray(messages) ? messages : [];

        sentMessagesTableBody.innerHTML = '';
        if (messagesCache.length === 0) {
          sentMessagesTableBody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø©</td></tr>';
        } else {
          messagesCache.forEach(msg => {
            const tr = document.createElement('tr');

            const sentAtText = msg.sentAt ? new Date(msg.sentAt).toLocaleString('ar-EG') : '-';
            const safeEmail = escapeHtml(String(msg.email ?? ''));
            const safeMessage = escapeHtml(String(msg.message ?? ''));

            // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ msg.id Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ØŒ Ø§Ù„Ø£ÙØ¶Ù„ Ù†Ø­Ø°ÙÙ‡ Ø¨Ø§Ù„Ù€ id
            const msgId = msg.id ?? msg._id ?? null;

            tr.innerHTML = `
              <td>${safeEmail}</td>
              <td style="text-align:right;">${safeMessage}</td>
              <td>${sentAtText}</td>
              <td>
                <button class="btn-icon btn-danger"
                  data-action="delete-message"
                  data-email="${encodeURIComponent(String(msg.email ?? ''))}"
                  data-id="${msgId ? encodeURIComponent(String(msgId)) : ''}">
                  ğŸ—‘ï¸
                </button>
              </td>
            `;
            sentMessagesTableBody.appendChild(tr);
          });
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        sentMessagesTableBody.querySelectorAll('button[data-action="delete-message"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const emailToDelete = decodeURIComponent(btn.getAttribute('data-email') || '');
            const idToDelete = decodeURIComponent(btn.getAttribute('data-id') || '');

            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ø¥Ù„Ù‰: ${emailToDelete} ØŸ`)) return;

            try {
              // Ù„Ùˆ Ø§Ù„Ø¨Ø§Ùƒ Ø¨ÙŠØ±Ø¬Ø¹ ID Ø§Ø³ØªØ®Ø¯Ù…Ù‡
              // ØºÙŠÙ‘Ø± Ø¬Ø³Ù… Ø§Ù„Ø·Ù„Ø¨ Ø­Ø³Ø¨ Ù…Ø§ ÙŠØ¯Ø¹Ù…Ù‡ Ø§Ù„Ø¨Ø§Ùƒ Ø¹Ù†Ø¯Ùƒ (Ø§Ù„Ø£ÙØ¶Ù„: Ø­Ø°Ù Ø¨Ø§Ù„Ù€ id)
              const body = idToDelete ? { id: idToDelete } : { email: emailToDelete };

              const delRes = await fetch('/api/admin/message', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
              });

              const data = await delRes.json().catch(() => ({}));
              if (delRes.ok) {
                alert(data.message || 'ØªÙ… Ø§Ù„Ø­Ø°Ù');
                await loadMessages();
              } else {
                alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
              }
            } catch {
              alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            }
          });
        });

        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        totalSentEl.textContent = messagesCache.length;
        const last = messagesCache
          .filter(m => m && m.sentAt)
          .map(m => new Date(m.sentAt))
          .sort((a, b) => b - a)[0];

        lastMessageSent = last ? last.toISOString() : null;
        updateLastSentUI();

      } catch (error) {
        sentMessagesTableBody.innerHTML = '<tr><td colspan="4">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</td></tr>';
        messagesCache = [];
        totalSentEl.textContent = '0';
        lastMessageSent = null;
        updateLastSentUI();
      }
    }

    function updateLastSentUI() {
      if (!lastMessageSent) return lastSentEl.textContent = '-';

      const now = new Date();
      const last = new Date(lastMessageSent);
      const diffMin = Math.floor((now - last) / 60000);

      if (diffMin < 1) lastSentEl.textContent = 'Ø§Ù„Ø¢Ù†';
      else if (diffMin < 60) lastSentEl.textContent = `Ù…Ù†Ø° ${diffMin} Ø¯Ù‚ÙŠÙ‚Ø©`;
      else if (diffMin < 1440) lastSentEl.textContent = `Ù…Ù†Ø° ${Math.floor(diffMin / 60)} Ø³Ø§Ø¹Ø©`;
      else lastSentEl.textContent = last.toLocaleDateString('ar-EG');
    }

    // ====== Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ======
    sendMessageBtn.addEventListener('click', async () => {
      const selected = emailList.filter(e => e.checked).map(e => e.email);
      const message = messageInput.value.trim();

      if (selected.length === 0) return showResponse('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙ„Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
      if (!message) return showResponse('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');

      // Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
      sendMessageBtn.disabled = true;
      const oldBtnHtml = sendMessageBtn.innerHTML;
      sendMessageBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

      try {
        // Ø¨Ù…Ø§ Ø¥Ù† API Ø¹Ù†Ø¯Ùƒ Ø¨ÙŠØ±Ø³Ù„ Ù„ÙˆØ§Ø­Ø¯ (email + message)
        // Ù‡Ù†Ø±Ø³Ù„ Ù„ÙƒÙ„ Ù…Ø³ØªÙ„Ù… Ø·Ù„Ø¨ Ù…Ù†ÙØµÙ„ (Ù…Ø¶Ù…ÙˆÙ† ÙŠØ´ØªØºÙ„ Ù…Ø¹ Ø¨Ø§ÙƒÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ)
        const results = await Promise.allSettled(
          selected.map(email =>
            fetch('/api/admin/message', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, message })
            }).then(async r => {
              const data = await r.json().catch(() => ({}));
              if (!r.ok) throw new Error(data.error || 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
              return data;
            })
          )
        );

        const okCount = results.filter(r => r.status === 'fulfilled').length;
        const failCount = results.length - okCount;

        if (okCount > 0 && failCount === 0) {
          showResponse(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${okCount} Ù…Ø³ØªÙ„Ù….`, 'success');
        } else if (okCount > 0 && failCount > 0) {
          showResponse(`ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ${okCount} Ù…Ø³ØªÙ„Ù…ØŒ ÙˆÙØ´Ù„ Ø¥Ù„Ù‰ ${failCount}.`, 'info');
        } else {
          showResponse('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.', 'error');
        }

        // ØªÙ†Ø¸ÙŠÙ
        messageInput.value = '';
        emailList.forEach(e => e.checked = false);
        initEmailOptionsUI();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await loadMessages();

      } catch {
        showResponse('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
      } finally {
        sendMessageBtn.disabled = false;
        sendMessageBtn.innerHTML = oldBtnHtml;
      }
    });

    // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    clearFormBtn.addEventListener('click', () => {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ØŸ')) return;

      messageInput.value = '';
      customEmailInput.value = '';
      emailList.forEach(e => e.checked = false);
      initEmailOptionsUI();
      showResponse('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­', 'info');
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    logoutBtn.addEventListener('click', async () => {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) return;

      try {
        const res = await fetch('/api/admin/logout', { method: 'POST' });
        if (res.ok) window.location.href = '/admin-login.html';
        else alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
      } catch {
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
      }
    });

    // Ø­Ù…Ø§ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ù…Ù† XSS ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµÙˆØµ (Ø£ÙØ¶Ù„ Ù…Ù…Ø§Ø±Ø³Ø©)
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    (async function init() {
      await loadUsers();
      await loadMessages();
      updateLastSentUI();
    })();
  </script>
</body>

</html>
